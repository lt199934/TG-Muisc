<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<div th:replace="client/common/include::admin_header('歌单管理')"></div>
<body>
<!--   header-->
<header class="col-md-12 column" style="padding: 0" th:include="admin/layout/include::head"></header>
<div class="container-fluid">
    <aside class="col-md-1" th:include="admin/layout/include::aside(active='songLists.html')"></aside>
    <main class="col-md-11">
        <div class="row">
            <div class="col-md-12">
                <!--面包屑导航-->
                <ol class="breadcrumb">
                    <li><a href="/admin/index">Home</a></li>
                    <li class="active">歌单管理</li>
                </ol>
                <!--搜索区域-->
                <div class="panel panel-default">
                    <div class="panel-body">
                        <form action="" id="selectForm">
                            <div class="form-group col-xs-12 col-sm-2 col-md-3 col-lg-2" style="padding-right: 5px">
                                <label class="" for="name">歌单名</label>
                                <input class="form-control " id="name" placeholder="请输入名称" type="text">
                            </div>
                            <div class="form-group col-xs-12 col-sm-2 col-md-3 col-lg-2" style="padding-right: 5px">
                                <label class="" for="fen">分类</label>
                                <select class="form-control fenLei" id="fen" name="fen">
                                    <option selected="selected" value="0">不限</option>
                                </select>
                            </div>
                            <div class="form-group col-xs-12 col-sm-2 col-md-3 col-lg-2" style="padding-right: 5px">
                                <label class="" for="startDate">开始时间：</label>
                                <input class="form-control " id="startDate" placeholder="请输入开始时间" type="text">
                            </div>
                            <div class="form-group col-xs-12 col-sm-2 col-md-3 col-lg-2" style="padding-right: 5px">
                                <label class="" for="endDate">结束时间：</label>
                                <input class="form-control " id="endDate" placeholder="请输入结束时间" type="text">
                            </div>
                        </form>

                    </div>
                </div>
            </div>
        </div>
        <!--数据主体-->
        <div class="row">
            <div class="col-md-12">
                <!-- 示例 -->
                <div class="panel panel-primary">
                    <div class="panel-heading">用户信息</div>
                    <div class="panel-body">
                        <div class="table-responsive">
                            <div id="toolbar">
                                <!-- 按钮触发模态框 -->
                                <button class="btn btn-success"
                                        data-target="#songListModal"
                                        data-toggle="modal"
                                        id="getInsertRows"
                                        onclick="init()"
                                        type="button"><i class="glyphicon glyphicon-plus"></i> 添加
                                </button>
                                <button class="btn btn-warning"
                                        id="reset"
                                        onclick="resetForm()"
                                        type="button">重置
                                </button>
                            </div>
                            <table class="table table-hover table-striped table-bordered" id="dataTable"></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
<div aria-labelledby="myModalLoginLabel" class="modal fade" id="songListModal" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button aria-label="Close" class="close" data-dismiss="modal" type="button"><span
                        aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="songListModalLabel">添加歌单页面</h4>
            </div>
            <div class="modal-body">
                <form id="songListForm">
                    <div class="row">
                        <div class="form-group songListId col-md-4">
                            <label class="control-label" for="songListId">ID</label>
                            <div class="input-group">
                                <span class="input-group-addon"><span class="glyphicon glyphicon-user"></span></span>
                                <input class="form-control" id="songListId" name="songListId" placeholder="请输入专辑ID"
                                       readonly
                                       type="text">
                            </div>
                        </div>
                        <div class="form-group col-md-4">
                            <label class="control-label" for="songList">歌单</label>
                            <div class="input-group">
                                        <span class="input-group-addon"><span
                                                class="glyphicon glyphicon-user"></span></span>
                                <input class="form-control" id="songList" name="songList"
                                       placeholder="请输入歌单名"
                                       type="text">
                            </div>
                        </div>
                        <div class="form-group col-md-4">
                            <label class="" for="fenLei">歌单分类</label>
                            <div class="input-group">
                                        <span class="input-group-addon"><span
                                                class="glyphicon glyphicon-info-sign"></span></span>
                                <select class="form-control fenLei" id="fenLei" name="fenLei">
                                    <option selected="selected" value="">请选择分类</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-4">
                            <label class="" for="img">歌单图片：</label>
                            <div class="input-group">
                                        <span class="input-group-addon"><span
                                                class="glyphicon glyphicon-picture"></span></span>
                                <img alt="加载失败" class="img-responsive" id="imgSrc" src=""/>
                                <input class="form-control img-responsive" id="img" name="img"
                                       placeholder="请上传专辑图片"
                                       type="file">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-6">
                            <label class="" for="userId">创建用户</label>
                            <div class="input-group">
                                        <span class="input-group-addon"><span
                                                class="glyphicon glyphicon-info-sign"></span></span>
                                <select class="form-control" id="userId" name="userId">
                                    <option selected="selected" value="">请选择用户</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label class="" for="time">创建时间</label>
                            <div class="input-group">
                                        <span class="input-group-addon"><span
                                                class="glyphicon glyphicon-calendar"></span></span>
                                <input class="form-control" id="time" name="time" placeholder="请输入创建时间"
                                       type="datetime-local">
                            </div>
                        </div>
                    </div>


                    <div class="form-group">
                        <label class="control-label" for="introduction">简介</label>
                        <div class="input-group">
                                        <span class="input-group-addon"><span
                                                class="glyphicon glyphicon-user"></span></span>
                            <textarea class="form-control" id="introduction" name="introduction"
                                      placeholder="请输入简介"
                                      rows="6"
                                      type="text"></textarea>
                        </div>
                    </div>


                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" data-dismiss="modal" type="button">取消</button>
                <input class="btn btn-primary" data-loading-text="添加..." id="subBtn" type="button"
                       value="添加">
            </div>
        </div>
    </div>
</div>
</body>
<div th:include="client/common/include::footer"></div>
<script src="/music/admin/js/isLogin.js"></script>
<script>
    let $imgSrc = $("#imgSrc");
    let $songListModal = $('#songListModal');
    let $songListForm = $('#songListForm');
    let $songListModalLabel = $('#songListModalLabel');
    $("#dataTable").bootstrapTable({
        url: "/songList/page", //请求后台的URL（*）
        method: 'get',     //请求方式（*）
        dataType: "json",   //服务器返回的数据类型
        toolbar: '#toolbar', //
        striped: true,      //是否显示行间隔色
        cache: false,       //是否使用AJAX数据缓存
        sortable: true,     //是否启用排序
        ordering: true, //是
        sortOrder: "asc",   //排序方式
        search: false,      //是否显示搜索
        sidePagination: "server", //设置在哪里进行分页，可选值为 ‘client’ 或者 ‘server’。设置 ‘server’时，必须设置 服务器数据地址（url）或者重写ajax方法
        pagination: true,   //是否显示分页组件
        showPaginationSwitch: true, //显示切换分页
        pageNumber: 1,      //第一页页数
        pageSize: 5,        //第一页条数
        pageList: [5, 10, 20, 50, 100], //每页显示多少条
        showFullscreen: true, //显示全屏
        showHeader: true,   //显示头部，默认显示
        showExport: true,   //显示导出
        showColumns: true,  //是否显示所有的列
        showRefresh: true, //是否显示刷新按钮
        showFooter: false, //是否显示底部
        minimumCountColumns: 2,  //最少允许的列数
        clickToSelect: true,   //是否启用点击选中行
        //height: 500,         //行高，如果没有设置height属性，表格自动根据记录条数觉得表格高度
        uniqueId: "ID",        //每一行的唯一标识，一般为主键列
        showToggle: true,     //是否显示详细视图和列表视图的切换按钮
        cardView: false,      //是否显示详细视图
        detailView: false,    //是否显示父子表
        queryParams: function (params) {
            return {
                "songList": $("#name").val(),
                "fenId": $("#fen").val(),
                "startDate": $("#startDate").val(),
                "endDate": $("#endDate").val(),
                "pageNum": (params.offset / params.limit) + 1,
                "pageSize": params.limit
            }
        },
        onLoadSuccess: function (res) {
            // console.log(res)
        },
        onLoadError: function () {
            showTips("数据加载失败！");
        },
        responseHandler: function (res) {
            console.log(res)
            return {
                total: res.total,
                rows: res.list
            }
        },
        columns: [
            {checkbox: true},
            {title: 'ID', field: 'songListId'},
            {
                title: '歌单封面', field: 'imgUrl', align: 'center', width: 100, formatter(value) {
                    return "<img src='" + value + "' alt='加载中。。。' style='width:50px;height:50px;border: 1px solid;'>";
                }
            },
            {title: '歌单', field: 'songList', sortable: true},
            {title: '简介', field: 'introduction', width: 600},
            {title: '创建用户', field: 'createUser'},
            {title: '创建时间', field: 'time'},
            {
                title: '操作', align: 'center', formatter: function (value, row, index) {
                    // console.log(row)
                    let res = "<button class='btn btn-sm btn-info' onclick='showDetailModal(" + row.songListId + ")' >详情</button>&nbsp;";
                    res += "<button class='btn btn-sm btn-primary' onclick='edit(" + JSON.stringify(row).replace(/\"/g, "&quot;").replace(/\'/g, "\\\'") + ")'>修改</button>&nbsp;";
                    res += "<button class='btn btn-sm btn-danger' onclick='del(" + row.songListId + ")'>删除</button>";
                    return res;
                }
            }],

    })

    $(function () {
        getFenLei();
    });
    $("#selectForm").change(function () {
        $("#dataTable").bootstrapTable('refresh');
    });
    $("#pageSize").change(function () {
        $("#dataTable").bootstrapTable('refresh');
    });

    function getFenLei() {
        $.ajax({
            "url": "/songList/fenLei",
            method: "post",
            success: function (data) {
                console.log(data);
                console.log("分类", data);
                for (var i = 0; i < data.length; i++) {
                    var $fen = $("<option value=" + data[i].fenId + ">" + data[i].content + "</option>");
                    $(".fenLei").append($fen)
                }
            }
        });
    }

    const showDetailModal = (songListId) => {
        // alert(songListId)
        window.location.href = "/admin/songListsData?songListId=" + songListId
    }

    const init = () => {
        $songListModalLabel.html("添加歌手");
        $("#subBtn").val("添加");
        $(".songListId").css('display', 'none');
        $imgSrc.css('display', 'none');
        $songListForm[0].reset();
        $songListForm.data('bootstrapValidator').destroy();
        $songListForm.data('bootstrapValidator', null);

    };
    const resetForm = () => {
        $("#selectForm")[0].reset();
        $("#dataTable").bootstrapTable('refresh');
    };

    const edit = (songList) => {
        $("#subBtn").val("更新");
        $songListModalLabel.html("歌单数据");
        $(".songListId").css("display", "block");
        $("#songListId").val(songList.songListId);
        $("#songList").val(songList.songList);
        $imgSrc.css("display", 'block');
        $("#imgSrc").attr("src", songList.imgUrl);
        $("#time").val(songList.time);
        // for (let i = 0; i < singers.length; i++) {
        //     if (singers[i].value === album.createUser.toString()) {
        //         singers[i].selected = true;
        //     }
        // }
        $("#introduction").val(songList.introduction);
        $songListModal.modal('show');
    }

    function del(songListId) {
        alert(songListId)
        // var url = "/delSongList/" + songListId;
        // $.ajax({
        //     url: url,
        //     method: "DELETE",
        //     success: function (data) {
        //         if (data == 1) {
        //             alert("删除成功");
        //         }
        //         getSongList(1);
        //     }
        // });
    }

    $("#subBtn").click(function () {
        var url = "/songList/save";
        var form = $("#songListForm")[0];
        var formData = new FormData(form);
        console.log(formData);
        $.ajax({
            url: url,
            method: "post",
            data: formData,
            dataType: 'JSON',
            cache: false,
            processData: false,
            contentType: false,
            success: function (data) {
                if (data.code === 200) {
                    toastr.success(data.msg, null, {positionClass: "toast-top-center"});
                    $songListForm[0].reset();
                    // $userForm.data('bootstrapValidator').resetForm(true);
                    $songListModal.modal("hide");
                } else {
                    toastr.error(data.msg, null, {positionClass: "toast-top-center"});
                }
                $("#dataTable").bootstrapTable('refresh');

            }
        });
    });
</script>
</html>